<!doctype html>
<html lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Temporary, pseudo-experiment</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="/static/lib/peerjs.min.js"></script>
    <script src="https://unpkg.com/uuid@latest/dist/umd/uuidv4.min.js"></script>
    <style type="text/css" media="screen">
        body {
            overflow: hidden;
        }

        #dataDisplay {
            overflow: scroll;
            max-height: 600px;
        }
    </style>
</head>

<body>
    <!--[if lt IE 8]>
            <p class="browserupgrade">
            You are using an <strong>outdated</strong> browser. Please
            <a href="http://browsehappy.com/">upgrade your browser</a> to improve
            your experience.
            </p>
        <![endif]-->
    <iframe id="simulatedExpScreen" title="ExperimentClient" width="600" height="400"></iframe>
    <div>
        <button type="button" id="newPeer">Generate Peer</button>
        <div id="idReadout" style="display:inline;">
            <div>
            </div>

            <h3>Received data:</h3>
            <ul id="dataDisplay"></ul>

</body>
<script type="text/javascript">
    let experimentClientID, peer, conn;
    const communications = {};

    // TODO clean this whole file up.
    function generatePeerConnection() {
        experimentClientID = uuidv4();
        peer = new Peer(experimentClientID);

        document.getElementById("idReadout").innerText = experimentClientID;
        const alphabet = 'abcedfghijk';
        const font = 'Sloan';
        const params = { 'alphabet': alphabet, 'font': font, 'peerID': experimentClientID };
        let queryString = Object.keys(params)
            .map(key => key + '=' + params[key])
            .join('&');
        let uri = 'https://testtestgus.xyz/init?' + queryString;
        console.log(uri);
        document.getElementById("simulatedExpScreen").src = uri;
        peer.on('connection', onConnection);
    };
    document.getElementById("newPeer")
            .addEventListener("click", generatePeerConnection);

    const onConnection = (conn) => {
        const onConnData = (data) => {
            if (experimentClientID in communications) {
                communications[experimentClientID].push(...data.response);
            } else {
                communications[experimentClientID] = [data.response];
            }
            updateDataDisplay(communications);
        };
        const onConnOpen = () => {
            conn.on('data', onConnData);
        };
        conn.on('open', onConnOpen);
    };

    const updateDataDisplay = (comms) => {
        display = document.getElementById('dataDisplay');
        let id, idLI, idData, idHeader, datum, datumReadout;
        for (id in comms) {
            idLI = document.createElement('li');
            idHeader = document.createElement('h2');
            idHeader.innerText = id;
            idData = document.createElement('ul')
            idLI.appendChild(idHeader);
            idLI.appendChild(idData);
            display.appendChild(idLI);
            for (datum in comms[id]) {
                datumReadout = document.createElement('li');
                datumReadout.innerText = datum;
                idData.appendChild(datumReadout);
            };
        };
    };
</script>

</html>